{% extends 'admin/a_dashbd.html' %}
{% load static %}

{% block content %}
<h2>Approved Requests</h2>

{% if not approved_requests %}
<div class="no-requests">No approved requests found.</div>
{% else %}
<div class="requests-table">
    <table>
        <thead>
            <tr>
                <th>#</th>
                <th>Sender</th>
                <th>Request Text</th>
                <th>Approved By</th>
                <th>Approval Date</th>
                <th>Details</th>
            </tr>
        </thead>
        <tbody>
            {% for req in approved_requests %}
            <tr class="main-row">
                <td>{{ forloop.counter }}</td>
                <td>{{ req.user.name }}</td>
                <td>{{ req.request_text|truncatechars:30 }}</td>
                <td>
                    {% with req.statuses.last as last_approval %}
                    {% if last_approval.status == 'approved' %}
                    {{ last_approval.approver.name }}
                    {% endif %}
                    {% endwith %}
                </td>
                <td>
                    {% with req.statuses.last as last_approval %}
                    {% if last_approval.status == 'approved' %}
                    {{ last_approval.timestamp|date:"d M Y H:i" }}
                    {% endif %}
                    {% endwith %}
                </td>
                <td>
                    <button onclick="toggleDetails('details-{{ req.request_id }}')" class="btn">View</button>
                </td>
            </tr>
            <tr class="details-row" id="details-{{ req.request_id }}" style="display:none;">
                <td colspan="6">
                    <div class="compact-details">
                        <div class="detail-row">
                            <span class="detail-label">File No:</span>
                            <span class="detail-value">{{ req.file_no }}</span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">Volume No:</span>
                            <span class="detail-value">{{ req.volume_no|default:"-" }}</span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">Security Classification:</span>
                            <span class="detail-value">{{ req.get_security_classification_display }}</span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">Description:</span>
                            <span class="detail-value">{{ req.request_text|default:"N/A" }}</span>
                        </div>

                        <div class="section-title">Attached Files:</div>
                        <div class="attachments">
                            {% if req.form_files.exists or req.enclosure_files.exists %}
                                {% if req.form_files.exists %}
                                <div class="file-type">Form Files:</div>
                                <ul>
                                    {% for file in req.form_files.all %}
                                    <li><a href="{{ file.file.url }}" target="_blank">{{ file.file.name|cut:"requests/forms/" }}</a></li>
                                    {% endfor %}
                                </ul>
                                {% endif %}
                                {% if req.enclosure_files.exists %}
                                <div class="file-type">Enclosure Files:</div>
                                <ul>
                                    {% for file in req.enclosure_files.all %}
                                    <li><a href="{{ file.file.url }}" target="_blank">{{ file.file.name|cut:"requests/enclosures/" }}</a></li>
                                    {% endfor %}
                                </ul>
                                {% endif %}
                            {% else %}
                                <div class="no-files">No files attached</div>
                            {% endif %}
                        </div>

                        <div class="section-title">Approval Flow:</div>
                        <div class="approval-flow">
                            {% for status in req.statuses.all|dictsort:"timestamp" %}
                            <div class="flow-item">
                                <span class="approver-name">{{ status.approver.name }}</span> -
                                <span class="action">{{ status.get_status_display }}</span>
                                <span class="date">({{ status.timestamp|date:"d M Y H:i" }})</span>
                                {% if status.comment %}
                                <div class="comment">Comment: {{ status.comment }}</div>
                                {% endif %}
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>
{% endif %}

<style>
    /* Clear visual distinction between labels and values */
    .detail-label {
        font-weight: bold;
        min-width: 150px;
        display: inline-block;
    }
    
    .detail-value {
        font-weight: normal;
    }
    
    /* Approval flow styling */
    .approver-name {
        font-weight: bold;
    }
    
    .action {
        font-weight: normal;
    }
    
    .date {
        color: #666;
        font-size: 0.9em;
    }
    
    .comment {
        color: #555;
        font-size: 0.9em;
        margin-top: 3px;
        padding-left: 10px;
    }
    
    /* Section titles */
    .section-title {
        font-weight: bold;
        margin: 15px 0 8px 0;
        padding-bottom: 3px;
        border-bottom: 1px solid #ddd;
    }
    
    /* File type labels */
    .file-type {
        font-weight: bold;
        margin-top: 8px;
    
    }
</style>
{% endblock %}
{% comment %} {% extends 'admin/a_dashbd.html' %}
{% load static %}

{% block content %}
<h2>Approved Requests</h2>

{% if not approved_requests %}
<div class="no-requests">No approved requests found.</div>
{% else %}
{% with requests=approved_requests show_status_column=False %}
{% include 'admin/test.html' %}
{% endwith %}
{% endif %}

{% endblock %}






{% comment %} {% extends 'admin/a_dashbd.html' %} {% endcomment %}
{% comment %} {% block content %}

<h2>Approved Requests</h2>

{% if not approved_requests %}
<div class="no-requests">No approved requests found.</div>
{% else %}
<div class="table-container">
    <table>
        <thead>
            <tr>
                <th>#</th>
                <th>User</th>
                <th>Description</th>
                <th>Date</th>
                <th>Action</th>
            </tr>
        </thead>
        <tbody>
            {% for req in approved_requests %}
            <tr>
                <td>{{ forloop.counter }}</td>
                <td>{{ req.user.name }}</td>
                <td>{{ req.request_text|truncatechars:30 }}</td>
                <td>{{ req.created_at|date:"M d, Y" }}</td>
                <td>
                    <button onclick="toggleDetails('details-{{ req.request_id }}')" class="btn">
                        View
                    </button>
                </td>
            </tr>
            <tr class="details-row" id="details-{{ req.request_id }}" style="display:none;">
                <td colspan="5">
                    <div class="request-details-container">
                        <div class="detail-section">
                            <h4>Request Details</h4>
                            <div class="detail-grid">
                                <div>
                                    <p><strong>File No:</strong> {{ req.file_no|default:"-" }}</p>
                                    <p><strong>Volume No:</strong> {{ req.volume_no|default:"-" }}</p>
                                </div>
                                <div>
                                    <p><strong>Classification:</strong> {{ req.get_security_classification_display }}
                                    </p>
                                    <p><strong>Submitted:</strong> {{ req.created_at|date:"M d, Y H:i" }}</p>
                                    <p><strong>Status:</strong> <span class="status {{ req.status }}">{{
                                            req.get_status_display }}</span></p>
                                </div>
                            </div>
                            <p><strong>Full Description:</strong></p>
                            <div class="description-box">{{ req.request_text }}</div>
                        </div>

                        <div class="detail-section">
                            <h4>Attachments</h4>
                            <div class="attachments-grid">
                                <div>
                                    <h5>Form Files</h5>
                                    {% if req.form_files.exists %}
                                    <ul>
                                        {% for file in req.form_files.all %}
                                        <li class="file-attachment">
                                            <span class="file-icon">ðŸ“„</span>
                                            <a href="{{ file.file.url }}" target="_blank">
                                                {{ file.file.name|cut:"requests/forms/" }}
                                            </a>
                                            <span class="file-size">({{ file.file.size|filesizeformat }})</span>
                                        </li>
                                        {% endfor %}
                                    </ul>
                                    {% else %}
                                    <p>No form files uploaded</p>
                                    {% endif %}
                                </div>
                                <div>
                                    <h5>Enclosure Files</h5>
                                    {% if req.enclosure_files.exists %}
                                    <ul>
                                        {% for file in req.enclosure_files.all %}
                                        <li class="file-attachment">
                                            <span class="file-icon">ðŸ“Ž</span>
                                            <a href="{{ file.file.url }}" target="_blank">
                                                {{ file.file.name|cut:"requests/enclosures/" }}
                                            </a>
                                            <span class="file-size">({{ file.file.size|filesizeformat }})</span>
                                        </li>
                                        {% endfor %}
                                    </ul>
                                    {% else %}
                                    <p>No enclosure files uploaded</p>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>
{% endif %}

{% endblock %} {% endcomment %}